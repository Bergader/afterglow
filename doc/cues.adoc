= Cues
James Elliott <james@deepsymmetry.org>
:icons: font

// Set up support for relative links on GitHub; add more conditions
// if you need to support other environments and extensions.
ifdef::env-github[:outfilesuffix: .adoc]

Cues are designed to support creating user interfaces for controlling
effects. They provide a convenient way to organize, identify, trigger,
adjust, and monitor effects. Each
http://deepsymmetry.org/afterglow/doc/afterglow.show.html[show] in
Afterglow maintains a cue grid, which can be viewed and interacted
with through the
http://deepsymmetry.org/afterglow/doc/afterglow.core.html#var-start-web-server[embedded
web interface] and MIDI controller mapping implementations which can
be
http://deepsymmetry.org/afterglow/doc/afterglow.show.html#var-register-grid-controller[registered
as grid controllers], like the
http://deepsymmetry.org/afterglow/doc/afterglow.controllers.ableton-push.html[Ableton
Push].

The cue grid is a two dimensional arrangement of cues, where the
bottom left corner is assigned coordinates `(0, 0)`. X coordinates
increase from left to right, and Y coordinates increase from bottom to
top. The web interface and registered grid controllers display 64 cues
at a time in an 8&times;8 grid, and can be scrolled around that grid.
The user can set the web interface to track the scroll position of a
registered grid controller. When that is done, scrolling either
interface will cause the other to scroll in the same way, so the
browser window can act as documentation to help the user learn the cue
names associated with each available cue pad on the controller.

image::assets/ShowGrid.png[Web interface]

In addition to names, cues can be assigned colors in the grid, and the
web interface will honor those colors, as will the physical grid
controllers, within the limits of their capabilities. To provide
feedback about cue activation, a lightened version of the cue color is
displayed for cues which are currently active. And to help inform the
user about cue compatibility, any cues which are assigned the same
effect keyword, meaning they will terminate each other when launched,
will be displayed in a darkened color if an effect with that keyword
is currently running. Examples of both of these can be seen in the
first column of cues above, in which the &ldquo;All Dimmers&rdquo; cue
is active and displaying a lightened version of the yellow color
assigned to it, and the two cues above it, &ldquo;All Saw Down
Beat&rdquo; and &ldquo;All Saw Up 2 Beat&rdquo; use the same keyword
and color, and so are displaying a darkened version of the yellow
color. This is a useful technique for building easy-to-learn cue
grids. The same cues are shown on the Ableton Push below, so you can
see how the color relationships help with learning the cue names.

image::assets/AbletonInterface.jpg[Ableton Push interface]

To trigger a cue, simply press the corresponding pad on a physical
interface, or click within the grid cell in the web interface. The
effect associated with the cue will be created and added to the show,
and the grid cell will be lightened to indicate that the cue&rsquo;s
effect is running. If the cue ends itself after a period, the grid
interface will be updated to reflect that as well.

To end a cue&rsquo;s effect before it would naturally end (or because
it is open-ended and does not end until asked to), simply press the
pad corresponding to the running cue (or, again, click the grid cell
in the web interface). The effect will be asked to end. Some effects
end instantly, which will be refleced by the cue grid cell returning
to its normal color. Some effects have a delayed ending, so they can
fade out, or finish some musically relevant sequence. If this is
happening, the grid cell will blink while the effect ends, and then
stay at its normal color once the effect finishes ending. If you want
the effect to end immediately you can press the pad one more time
while the effect is performing its gradual ending, and it will be
killed at that point, regardless of how much longer it was planning to
run.

Cues can also be created which run only as long as the corresponding
controller pad is held down (this is done by passing a true value with
the `:held` optional keyword argument when creating the cue). This is
often done for intense effects like strobes. Currently, only physical
controllers, not the web interface, honor the `:held` flag, since with
the web interface only one cell can be clicked at a time. (This will
be easy to change if there is demand for it.)

Cues can also offer pressure sensitivity on controllers which support
this (like the Ableton Push). For such cues, one or more variable used
by the cue can be updated by the aftertouch pressure exerted by the
operator as they hold down the pad. This can make for very expressive
effects, as exemplified by the Sparkle cue set up early in the
examples namespace&rsquo;s
http://deepsymmetry.org/afterglow/doc/afterglow.examples.html#var-make-cues[make-cues]
function, and its
http://deepsymmetry.org/afterglow/doc/afterglow.examples.html#var-make-strobe-cue[strobe]
cues. Of course, this pressure sensitivity is not possible with the
web cue grid.

The interface for moving around the cue grid is the diamond of arrows
at the bottom right of both the web interface and the Ableton Push. If
there are more cues available in a particular direction, that arrow is
lit, otherwise it is dark. For the cues pictured above, the bottom
left corner of the cue grid is being displayed, and there are more
cues above and to the right, so the up and right scroll arrows are
lit. Pressing an arrow scrolls to the next set of eight rows or
columns in that direction. (And if the web view is linked to a grid
controller, pressing the arrow on either will scroll both. For
physical grid controllers which lack scroll buttons, linking them to
the web interface is the most practical way of scrolling them.)

Cues can also be triggered from simpler MIDI controllers (which
don&rsquo;t register as grid controllers) by explicitly mapping notes
or control changes sent by the controller to cues within the grid
using
http://deepsymmetry.org/afterglow/doc/afterglow.show.html#var-add-midi-control-to-cue-mapping[afterglow.show/add-midi-control-to-cue-mapping].
Regardless of the mechanism by which a cue is triggered, the web
interface, a registered grid controller, or an explicitly mapped MIDI
note or control change, feedback will be sent to all interfaces so the
status of the cue will be represented consistently on all of them. And
a cue triggered on one controller can be ended on any other controller
by simply pressing the lit button or clicking the lit cell there.

For example, to be able to trigger the Sparkle cue, which the examples
namespace places at `(0, 7)` within the sample show cue grid, by
pressing the bottom leftmost button on my inexpensive Korg nanoKontrol
2 MIDI controller, after using
http://deepsymmetry.org/afterglow/doc/afterglow.midi.html#var-identify-mapping[afterglow.midi/identify-mapping]
to determine that the button sends control-change messages for
controller number `43`, I can simply evaluate:

[source,clojure]
----
(show/add-midi-control-to-cue-mapping "nano" 0 :control 43 0 7)
----

Now I can press the top-left pad on the Push, click the top left cell
in the Web interface, or press that button on the nanoKontrol, and the
Sparkle cue lights up on all three interfaces, and the effect runs and
sparkles the lights.

[NOTE]
====

In order to enable Afterglow to send feedback about cue status to the
lights on the nanoKontrol I needed to use the Korg Kontrol Editor to
set its LED Mode to _External_ (as shipped, they were in _Internal_
mode, and lit themselves when held down). Most MIDI controllers are
likely to need similar configuration to work as feedback-capable cue
controllers with Afterglow, but most I have seen do offer
configuration tools to enable this kind of external control.

====

[[creating-cues]]
Creating Cues
~~~~~~~~~~~~~

The
http://deepsymmetry.org/afterglow/doc/afterglow.effects.cues.html[afterglow.effects.cues]
namespace provides functions for creating cues. Unsurprisingly, the
http://deepsymmetry.org/afterglow/doc/afterglow.effects.cues.html#var-cue[cue]
function creates a cue. At its most basic, you pass in two parameters,
`show-key` which is the keyword that will be used to add the
cue&rsquo;s effect to the show when the cue is triggered, ending any
other effect running under that same keyword, and `effect`, which is a
function that will be called when the cue is triggered, and whose
responsibility is to create and return the effect that the cue should
add to the show. This is done so that a fresh instance of the effect
is used each time the cue is triggered, in case the effect is complex
and maintains its own state. The effect creation function will be
passed a map containing any cue-specific variable bindings.

There are a number of optional keyword parameters which can be used to
modify the cue that is created. A summary of some features are
presented here, but be sure to see the
http://deepsymmetry.org/afterglow/doc/afterglow.effects.cues.html#var-cue[API
documentation] for the full details.

[cols="2", options="header"]
|===
|Parameter
|Purpose

|`:color`
|sets the color of the cue within the grid for hinting about
purpose and relatedness to help operators learn and understand the
interface.

[[controlling-cues]]
Controlling Cues
~~~~~~~~~~~~~~~~

The
http://deepsymmetry.org/afterglow/doc/afterglow.controllers.html[afterglow.controllers]
namespace defines some helpful functions for working with cues, and
defines a
http://deepsymmetry.org/afterglow/doc/afterglow.controllers.html#var-IGridController[grid
controller protocol] which rich controller mappings, like the one for
the
http://deepsymmetry.org/afterglow/doc/afterglow.controllers.ableton-push.html[Ableton
Push], use to attach themselves to a running show, and synchronize
with the web interface.

TODO: Flesh out, discuss individual functions.
